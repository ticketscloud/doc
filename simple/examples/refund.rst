.. _ex/refund:

Возврат билетов
===============

Для возврата нам потребуется :ref:`заказ <simple/orders/create>`
в статусе :ref:`done`, его ``id``, список ``id`` билетов из этого заказа,
которые надо вернуть и виновник.

Допустим покупатель решил вернуть два билета из заказа.

Создаем :ref:`запрос на возврат <simple/refund>`:

**Request**:

.. sourcecode:: http

    POST /v1/resources/refund_requests HTTP/1.1
    Host: api.ticketscloud.org
    Accept: application/json
    Authorization:  key 968cd37341029c26d173b1113f0002cd
    Content-Type: application/json

    {
        "culprit": "user",
        "order": "5703d7542d709509727f929c",
        "tickets_refund": [
            "56ba2b6f9cb53851972a28db",
            "56ba2b6f9cb53851972a2883"
        ]
    }


**Response**:

.. sourcecode:: http

    HTTP/1.1 201 Created
    Content-Type: application/json; charset=UTF-8
    X-Partner: 54bcf9269cb53859759321c8

    {
        "created_at": "2016-04-05T15:34:02.502481+00:00",
        "culprit": "user",
        "id": "5703daea2d709509727f92a5",
        "order": "5703d7542d709509727f929c",
        "org": "54bcf9269cb538597597b5c8",
        "payment_system": "545b544a5d645a463e779d53",
        "status": "new",
        "tickets_refund": [
            "56ba2b6f9cb53851972a28db",
            "56ba2b6f9cb53851972a2883"
        ],
        "tickets": [],
        "updated_at": "2016-04-05T15:34:02.502481+00:00",
        "value": "0.00",
        "vendor": "54bcf9269c3248597597b5c8"
    }

После успешного создания запроса на возрат мы можем подтвердить его.
Для этого нам понадобится только ``id`` :ref:`запроса на возврат <simple/refund>`.

**Request**:

.. sourcecode:: http

    PATCH /v1/resources/refund_requests/5703daea2d709509727f92a5 HTTP/1.1
    Host: api.ticketscloud.org
    Accept: application/json
    Authorization:  key 968cd37341029c26d173b1113f0002cd
    Content-Type: application/json

    {
        "status": "approved"
    }


**Response**:

.. sourcecode:: http

    HTTP/1.1 201 Created
    Content-Type: application/json; charset=UTF-8
    X-Partner: 54bcf9269cb53859759321c8

    {
        "created_at": "2016-04-05T15:41:10.130000+00:00",
        "culprit": "user",
        "id": "5703daea2d709509727f92a5",
        "order": "5703d7542d709509727f929c",
        "org": "54bcf9269cb538597597b5c8",
        "payment_system": "545b544a5d645a463e779d53",
        "status": "approved",
        "tickets_refund": [
            "56ba2b6f9cb53851972a28db",
            "56ba2b6f9cb53851972a2883"
        ],
        "tickets": [],
        "updated_at": "2016-04-05T15:41:10.130000+00:00",
        "value": "0.00",
        "vendor": "54bcf9269c3248597597b5c8"
    }


После успешного подтверждения :ref:`запроса на возврат <simple/refund>`
деньги будут возвращениы в соответствии с логикой системы.

Ошибки при создании возврата
============================

+------------------------------------------------------------------------+--------------------------------------+
| сообщение                                                              | причина                              |
+========================================================================+======================================+
| <field> is required                                                    | не указано поле <field>              |
+------------------------------------------------------------------------+--------------------------------------+
| culprit Value '<value>' not in list of avaiable values ['user', 'org'] | неверно указан виновник возврата     |
+------------------------------------------------------------------------+--------------------------------------+
| Order {order_id} not found                                             | не найден заказ                      |
+------------------------------------------------------------------------+--------------------------------------+
| Operation failed: less than three days before event start              | меньше 3 дней до начала, по ФЗ-193   |
|                                                                        | возврат невозможен                   |
+------------------------------------------------------------------------+--------------------------------------+
| Operation failed: event already start                                  | мероприятие началось, по ФЗ-193      |
|                                                                        | возврат невозможен                   |
+------------------------------------------------------------------------+--------------------------------------+
| Operation failed: there is discounted ticket                           | билет со скидкой, возврат невозможен |
+------------------------------------------------------------------------+--------------------------------------+
| Operation failed: Mixed percentage values of tickets in one refund     | билеты с разными скидками,           |
|                                                                        | возврат невозможен                   |
+------------------------------------------------------------------------+--------------------------------------+
| bad culprit: {}                                                        | неверно указан виновник возврата     | 
+------------------------------------------------------------------------+--------------------------------------+
| wrong order (id: {}) status: {}                                        | заказ не в статусе done              |
+------------------------------------------------------------------------+--------------------------------------+
| Refund with culprit core must take all tickets from order              | в возврате не все билеты             |
+------------------------------------------------------------------------+--------------------------------------+
| Value Error                                                            | возврат не создался,                 |
|                                                                        | точная причина неизвестна            |
+------------------------------------------------------------------------+--------------------------------------+
| bad tickets                                                            | указаны билеты не из заказа          |
+------------------------------------------------------------------------+--------------------------------------+
| Unexpected situation                                                   | ошибка при создании платежей         |
+------------------------------------------------------------------------+--------------------------------------+
| RefundRequest in wrong status {!r} for create refund payment           | неверный статус возврата             |
|                                                                        | при создании платежей                |
+------------------------------------------------------------------------+--------------------------------------+

**Пример ошибки**

    .. sourcecode:: js

        {
            "errors": [
                "culprit Value 'idunno' not in list of avaiable values ['user', 'org']",
                "tickets list length is less than 1"
            ]
        }
